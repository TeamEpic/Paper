From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Hazerd <dransom96@gmail.com>
Date: Fri, 26 Jun 2020 21:02:03 -0400
Subject: [PATCH] Monumenta - Mobs that despawn return to their spawners


diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 36fbe16e6f06fca3eb282cce5b8c5fcc87a0166d..fd332d51baf1fdf36cd948478d8cb9de523fc7ba 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -192,6 +192,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
     public long activatedTick = Integer.MIN_VALUE;
     public boolean isTemporarilyActive = false; // Paper
     public boolean spawnedViaMobSpawner; // Paper - Yes this name is similar to above, upstream took the better one
+    public MobSpawnerAbstract spawnerSpawnedBy = null; // Monumenta
     public boolean fromNetherPortal; // Paper
     protected int numCollisions = 0; // Paper
     public void inactiveTick() { }
@@ -330,6 +331,27 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
         return this.id;
     }
 
+    // Monumenta START
+    public void despawn() {
+        if (this instanceof EntityLiving && this.spawnerSpawnedBy != null && ((EntityLiving)this).getHealth() >= 1 && this.locY() > 0) {
+            // Get the closest player to the spawner
+            EntityHuman entityhuman = this.world.a(this.spawnerSpawnedBy.b().getX(), this.spawnerSpawnedBy.b().getY(), this.spawnerSpawnedBy.b().getZ(), -1, false);
+            if (entityhuman != null) {
+                // Figure out how far that player is from the spawner
+                double dX = (entityhuman.locX() - this.spawnerSpawnedBy.b().getX());
+                double dY = (entityhuman.locY() - this.spawnerSpawnedBy.b().getY());
+                double dZ = (entityhuman.locZ() - this.spawnerSpawnedBy.b().getZ());
+                double nearestPlayerDistanceSquared = dX * dX + dY * dY + dZ * dZ;
+                if (nearestPlayerDistanceSquared >= 576) { // 24 * 24
+                    // No players are next to the spawner the mob came from - reprime it
+                    this.spawnerSpawnedBy.spawnDelay = 0;
+                }
+            }
+        }
+        die();
+    }
+    // Monumenta END
+
     public void die() {
         this.dead = true;
     }
diff --git a/src/main/java/net/minecraft/server/EntityInsentient.java b/src/main/java/net/minecraft/server/EntityInsentient.java
index 6d716214e756fe1326cd3d2becea969076f6fd5b..6673e6abf43674a79ed6ad39138ac6e1b2203fae 100644
--- a/src/main/java/net/minecraft/server/EntityInsentient.java
+++ b/src/main/java/net/minecraft/server/EntityInsentient.java
@@ -708,7 +708,7 @@ public abstract class EntityInsentient extends EntityLiving {
     @Override
     public void checkDespawn() {
         if (this.world.getDifficulty() == EnumDifficulty.PEACEFUL && this.L()) {
-            this.die();
+            this.despawn(); // Monumenta
         } else if (!this.isPersistent() && !this.isSpecialPersistence()) {
             EntityHuman entityhuman = this.world.findNearbyPlayer(this, -1.0D, IEntitySelector.affectsSpawning); // Paper
 
@@ -718,14 +718,14 @@ public abstract class EntityInsentient extends EntityLiving {
                 int j = i * i;
 
                 if (d0 > (double) world.paperConfig.hardDespawnDistance) { // CraftBukkit - remove isTypeNotPersistent() check // Paper - custom despawn distances
-                    this.die();
+                    this.despawn(); // Monumenta
                 }
 
                 int k = this.getEntityType().e().g();
                 int l = k * k;
 
                 if (this.ticksFarFromPlayer > 600 && this.random.nextInt(800) == 0 && d0 > world.paperConfig.softDespawnDistance) { // CraftBukkit - remove isTypeNotPersistent() check // Paper - custom despawn distances
-                    this.die();
+                    this.despawn(); // Monumenta
                 } else if (d0 < (double) l) {
                     this.ticksFarFromPlayer = 0;
                 }
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index bd900f8bb78461b0a57070f5968d3f7e87b01c0d..fb898f176c5c21a8f5db2e75905304098f3e6780 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -762,6 +762,12 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         this.extinguish();
         this.setFlag(0, false);
         this.getCombatTracker().g();
+
+        // Monumenta START - don't allow mobs to reprime spawners when they are near players that die.
+        for (org.bukkit.entity.Entity nearby : this.world.getWorld().getNearbyEntities(new Location(this.world.getWorld(), this.locX(), this.locY(), this.locZ()), 24.0d, 24.0d, 24.0d)) {
+            ((org.bukkit.craftbukkit.entity.CraftEntity)nearby).getHandle().spawnerSpawnedBy = null;
+        }
+        // Monumenta END
     }
 
     private void eW() {
diff --git a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
index c2e830db7aa2944a477624e149a3ba66d112b68a..1df2df43954351644f9231ec7a65ec7a3b75f95a 100644
--- a/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
+++ b/src/main/java/net/minecraft/server/MobSpawnerAbstract.java
@@ -166,6 +166,12 @@ public abstract class MobSpawnerAbstract {
                                 // Spigot End
                             }
                         entity.spawnedViaMobSpawner = true; // Paper
+                            // Monumenta START
+                            if (!(entity instanceof EntityFlying || entity instanceof EntityVex)) {
+                                entity.spawnerSpawnedBy = this;
+                            }
+                            // Monumenta END
+
                             entity.spawnReason = org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.SPAWNER; // Paper
                             flag = true; // Paper
                             // Spigot Start

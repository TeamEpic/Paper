From 1505137d14c1e680959b3a3c73e0dd10bc263780 Mon Sep 17 00:00:00 2001
From: Byron Marohn <combustible@live.com>
Date: Sat, 28 Mar 2020 03:35:42 -0400
Subject: [PATCH] Monumenta - Add events for loading and saving advancement
 data


diff --git a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
index 5b9b5e925..85d4fea0a 100644
--- a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
+++ b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
@@ -129,9 +129,18 @@ public class AdvancementDataPlayer {
     }
 
     private void g() {
-        if (this.e.isFile()) {
+        // Paper Start
+        com.destroystokyo.paper.event.player.PlayerAdvancementDataLoadEvent event = new com.destroystokyo.paper.event.player.PlayerAdvancementDataLoadEvent(this.player.getBukkitEntity(), this.e);
+        event.callEvent();
+        if (event.getPath().isFile() || event.getJsonData() != null) {
             try {
-                JsonReader jsonreader = new JsonReader(new StringReader(Files.toString(this.e, StandardCharsets.UTF_8)));
+                final JsonReader jsonreader;
+                if (event.getJsonData() != null) {
+                    jsonreader = new JsonReader(new StringReader(event.getJsonData()));
+                } else {
+                    jsonreader = new JsonReader(new StringReader(Files.toString(event.getPath(), StandardCharsets.UTF_8)));
+                }
+                // Paper End
                 Throwable throwable = null;
 
                 try {
@@ -160,7 +169,7 @@ public class AdvancementDataPlayer {
                         if (advancement == null) {
                             // CraftBukkit start
                             if (((MinecraftKey) entry.getKey()).b().equals("minecraft")) {
-                                AdvancementDataPlayer.a.warn("Ignored advancement '{}' in progress file {} - it doesn't exist anymore?", entry.getKey(), this.e);
+                                AdvancementDataPlayer.a.warn("Ignored advancement '{}' in progress file {} - it doesn't exist anymore?", entry.getKey(), event.getPath()); // Paper
                             }
                             // CraftBukkit end
                         } else {
@@ -185,9 +194,9 @@ public class AdvancementDataPlayer {
 
                 }
             } catch (JsonParseException jsonparseexception) {
-                AdvancementDataPlayer.a.error("Couldn't parse player advancements in {}", this.e, jsonparseexception);
+                AdvancementDataPlayer.a.error("Couldn't parse player advancements in {}", event.getPath(), jsonparseexception); // Paper
             } catch (IOException ioexception) {
-                AdvancementDataPlayer.a.error("Couldn't access player advancements in {}", this.e, ioexception);
+                AdvancementDataPlayer.a.error("Couldn't access player advancements in {}", event.getPath(), ioexception); // Paper
             }
         }
 
@@ -210,15 +219,21 @@ public class AdvancementDataPlayer {
             }
         }
 
-        if (this.e.getParentFile() != null) {
-            this.e.getParentFile().mkdirs();
+        // Paper start
+        com.destroystokyo.paper.event.player.PlayerAdvancementDataSaveEvent event = new com.destroystokyo.paper.event.player.PlayerAdvancementDataSaveEvent(this.player.getBukkitEntity(), this.e, AdvancementDataPlayer.b.toJson(map));
+        if (!event.callEvent()) {
+            return;
+        }
+        if (event.getPath().getParentFile() != null) {
+            event.getPath().getParentFile().mkdirs();
         }
 
         try {
-            Files.write(AdvancementDataPlayer.b.toJson(map), this.e, StandardCharsets.UTF_8);
+            Files.write(event.getJsonData(), event.getPath(), StandardCharsets.UTF_8);
         } catch (IOException ioexception) {
-            AdvancementDataPlayer.a.error("Couldn't save player advancements to {}", this.e, ioexception);
+            AdvancementDataPlayer.a.error("Couldn't save player advancements to {}", event.getPath(), ioexception);
         }
+        // Paper end
 
     }
 
-- 
2.17.1


From c52825ad5fca55f99097443da097dc794dcd6dc3 Mon Sep 17 00:00:00 2001
From: Byron Marohn <combustible@live.com>
Date: Sat, 9 May 2020 01:54:16 +0000
Subject: [PATCH] Monumenta - Move player saving to before disabling plugins

Signed-off-by: Byron Marohn <combustible@live.com>

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 8db5c6a35..cce1ed143 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -648,13 +648,6 @@ public abstract class MinecraftServer implements IAsyncTaskHandler, IMojangStati
         MinecraftServer.LOGGER.info("Stopping server");
         MinecraftTimings.stopServer(); // Paper
         // CraftBukkit start
-        if (this.server != null) {
-            this.server.disablePlugins();
-        }
-        // CraftBukkit end
-        if (this.getServerConnection() != null) {
-            this.getServerConnection().b();
-        }
 
         if (this.playerList != null) {
             MinecraftServer.LOGGER.info("Saving players");
@@ -663,6 +656,14 @@ public abstract class MinecraftServer implements IAsyncTaskHandler, IMojangStati
             try { Thread.sleep(100); } catch (InterruptedException ex) {} // CraftBukkit - SPIGOT-625 - give server at least a chance to send packets
         }
 
+        if (this.server != null) {
+            this.server.disablePlugins();
+        }
+        // CraftBukkit end
+        if (this.getServerConnection() != null) {
+            this.getServerConnection().b();
+        }
+
         MinecraftServer.LOGGER.info("Saving worlds");
         Iterator iterator = this.getWorlds().iterator();
 
-- 
2.17.1

